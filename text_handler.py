import logging
from typing import Optional, Tuple, List
from aiogram import types
from aiogram.types import Message

from main import bot, create_jira_ticket, TRIGGER_TAGS, CHECK_TAG, THREAD_PREFIXES

logger = logging.getLogger(__name__)

def get_thread_prefix(message: Message) -> str:
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—Ä–µ—Ñ–∏–∫—Å –ø–æ–¥–∑–∞–¥–∞—á–∏ –ø–æ thread_id"""
    return THREAD_PREFIXES.get(message.message_thread_id, '')

def clean_summary(text: str, tags: List[str]) -> str:
    """–£–¥–∞–ª—è–µ—Ç –∑–∞–¥–∞–Ω–Ω—ã–µ —Ç–µ–≥–∏ –∏–∑ —Ç–µ–∫—Å—Ç–∞"""
    for tag in tags:
        text = text.replace(tag, '')
    return ' '.join(text.split()).strip()

async def handle_text_message(message: Message):
    text = message.text or ""
    text_lower = text.lower()
    logger.info(f"‚úâÔ∏è –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ: {text}")

    if CHECK_TAG in text_lower:
        await message.reply("‚úÖ –ë–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç –∏ –≥–æ—Ç–æ–≤ –ø—Ä–∏–Ω–∏–º–∞—Ç—å –∑–∞–¥–∞—á–∏.")
        return

    if any(tag in text_lower for tag in TRIGGER_TAGS):
        await message.reply("üîÑ –û–±–Ω–∞—Ä—É–∂–µ–Ω —Ç–µ–≥, —Å–æ–∑–¥–∞—é –∑–∞–¥–∞—á—É –≤ Jira...")
        success, issue_key = await create_jira_ticket(
            text,
            message.from_user.full_name,
            file_bytes=None,
            filename=None,
            thread_prefix=get_thread_prefix(message)
        )
        if success:
            await message.reply(
                f"‚úÖ –ó–∞–¥–∞—á–∞ <b>{issue_key}</b> —Å–æ–∑–¥–∞–Ω–∞!\n"
                f"üîó <a href='{bot.url}/browse/{issue_key}'>{bot.url}/browse/{issue_key}</a>"
            )
        else:
            await message.reply("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–¥–∞—á–∏ –≤ Jira.")
